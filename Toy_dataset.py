import numpy as np
import pandas as pd
import constants


def seqs(seqnum,seqlength,group_name,gc_content,seed=None, BASES=constants.RNABASES):
    """generates a random set of DNA sequences for a group
    BASES: list of bases
    seqnum: number of sequences
    seqlength: length of sequence
    group_name: name of group
    seq_final= output der Funktion, numpy array mit seqnum Sequenzen die seqlength lang sind
    """
    BASES = np.array(BASES)
    rng = np.random.default_rng(seed=seed)
    probabilities = [(1-gc_content)/2, gc_content/2, gc_content/2, (1-gc_content)/2]
    seqs_raw = rng.choice(BASES, size=(seqnum, seqlength),p=probabilities)
    seperator = ""
    seqs_final = []
    for seq in seqs_raw:
        seqs_final.append(seperator.join(seq))
    seqs_final = np.array(seqs_final)
    group = np.array([group_name] * seqnum)
    seqs_final = np.vstack((seqs_final, group)).T

    return seqs_final


class RanSequence:
    """Contains sequences randomly generated by the seqs function"""

    def __init__(self, seqnum, seqlength, seed=None, group_name="Random", gc_content=0.5,BASES=constants.RNABASES):
        self.seqnum = seqnum
        self.seqlength = seqlength
        self.group_name = group_name
        self.seed = seed # This variable is used to recreate the same set of random Sequences, same seed = same data
        self.gc_content = gc_content
        self.BASES = BASES
        self.seqs = seqs(self.seqnum, self.seqlength, self.group_name,self.gc_content,self.seed,BASES=self.BASES)



    def __str__(self):
        return str(self.seqs)

    def save(self,fname="toy_dataset.txt",delimiter="\t",newline="\n"):
        """Saves sequences to text file"""
        np.savetxt(fname, self.seqs, delimiter=delimiter, newline=newline, fmt='%s')

class uORF_Statistics:
    """This class contains methods to calculate different statistics of uORFs"""
    def __init__(self):
        pass


    @staticmethod
    def codons(seqs):
        """This method splits sequences into codons and their respective reading frames"""
        codons = {
            "frame1": [],
            "frame2": [],
            "frame3": []
        }
        '''We have the option of either reading a pandas DataFrame of sequence or a single sequence string'''
        if type(seqs) == pd.DataFrame:
            seqstrings = seqs["Sequence"].values
            for seqstring in seqstrings:
                gnirtsqes = seqstring[::-1]
                frame1, frame2, frame3 = [], [], []

                for i in range(len(gnirtsqes)):
                    if i + 3 <= len(gnirtsqes):
                        if i % 3 == 0:
                            frame1.append(gnirtsqes[i] + gnirtsqes[i + 1] + gnirtsqes[i + 2])
                        if i % 3 == 1:
                            frame2.append(gnirtsqes[i] + gnirtsqes[i + 1] + gnirtsqes[i + 2])
                        if i % 3 == 2:
                            frame3.append(gnirtsqes[i] + gnirtsqes[i + 1] + gnirtsqes[i + 2])
                    else:
                        break

                frame1, frame2, frame3 = frame1[::-1], frame2[::-1], frame3[::-1]
                for i in range(len(frame1)):
                    frame1[i] = frame1[i][::-1]
                for i in range(len(frame2)):
                    frame2[i] = frame2[i][::-1]
                for i in range(len(frame3)):
                    frame3[i] = frame3[i][::-1]
                codons['frame1'].append(frame1)
                codons['frame2'].append(frame2)
                codons['frame3'].append(frame3)

        if type(seqs) == str:
            seqstring = seqs
            gnirtsqes = seqstring[::-1]

            frame1, frame2, frame3 = [], [], []

            for i in range(len(gnirtsqes)):
                if i + 3 <= len(gnirtsqes):
                    if i % 3 == 0:
                        frame1.append(gnirtsqes[i] + gnirtsqes[i + 1] + gnirtsqes[i + 2])
                    if i % 3 == 1:
                        frame2.append(gnirtsqes[i] + gnirtsqes[i + 1] + gnirtsqes[i + 2])
                    if i % 3 == 2:
                        frame3.append(gnirtsqes[i] + gnirtsqes[i + 1] + gnirtsqes[i + 2])
                else:
                    break

            frame1, frame2, frame3 = frame1[::-1], frame2[::-1], frame3[::-1]
            for i in range(len(frame1)):
                frame1[i] = frame1[i][::-1]
            for i in range(len(frame2)):
                frame2[i] = frame2[i][::-1]
            for i in range(len(frame3)):
                frame3[i] = frame3[i][::-1]
            codons['frame1'].append(frame1)
            codons['frame2'].append(frame2)
            codons['frame3'].append(frame3)
        return pd.DataFrame(codons)
    @staticmethod
    def uORFs(seqs):
        """This Method takes a pandas Dataframe of sequences or a string
         of one sequence outputs a pandas DataFrame countaining the number
         of uORFs, ouORFs in each sequence and the mean length of uORFs per Sequence"""
        frames = uORF_Statistics.codons(seqs)
        counts = {
            "uORF_countssum": list(np.zeros(len(frames))),
            "ouORF_countssum": list(np.zeros(len(frames))),

            "uORF_counts1": list(np.zeros(len(frames))),
            "uORF_counts2": list(np.zeros(len(frames))),
            "uORF_counts3": list(np.zeros(len(frames))),

            "uORF_meanlength1": list(np.zeros(len(frames))),
            "uORF_meanlength2": list(np.zeros(len(frames))),
            "uORF_meanlength3": list(np.zeros(len(frames))),

            "ouORF_counts1": list(np.zeros(len(frames))),
            "ouORF_counts2": list(np.zeros(len(frames))),
            "ouORF_counts3": list(np.zeros(len(frames))),
        }
        counts = pd.DataFrame(counts)

        '''We created the Dataframe in which we will store our data,
        in the following code we iterate through the 3 different reading frames 
        and search for start and stopcodons and depending on what we find, save our counts.'''

        for index in range(len(frames["frame1"])):
            seq = frames["frame1"][index]
            for codon in range(len(seq)):
                lengths = []
                if seq[codon] == "AUG":
                    uORF_length = 0
                    ouORF_bool = True
                    for nextcodon in range(len(seq)):
                        uORF_length += 3
                        if seq[nextcodon] in constants.stopcodons:
                            ouORF_bool = False
                            counts.loc[index, "uORF_counts1"] += 1
                            counts.loc[index, "uORF_countssum"] += 1
                            lengths.append(uORF_length)
                            break
                    if ouORF_bool:
                        counts.loc[index, "ouORF_countssum"] += 1
                        counts.loc[index, "ouORF_counts1"] += 1

        for index in range(len(frames["frame2"])):
            seq = frames["frame2"][index]
            for codon in range(len(seq)):
                lengths = []
                if seq[codon] == "AUG":
                    uORF_length = 0
                    ouORF_bool = True
                    for nextcodon in range(len(seq)):
                        uORF_length += 3
                        if seq[nextcodon] in constants.stopcodons:
                            ouORF_bool = False
                            counts.loc[index, "uORF_counts2"] += 1
                            counts.loc[index, "uORF_countssum"] += 1
                            lengths.append(uORF_length)
                            break
                    if ouORF_bool:
                        counts.loc[index, "ouORF_countssum"] += 1
                        counts.loc[index, "ouORF_counts2"] += 1

        for index in range(len(frames["frame3"])):
            seq = frames["frame3"][index]
            for codon in range(len(seq)):
                lengths = []
                if seq[codon] == "AUG":
                    uORF_length = 3
                    ouORF_bool = True
                    for nextcodon in range(len(seq)):
                        uORF_length += 3
                        if seq[nextcodon] in constants.stopcodons:
                            ouORF_bool = False
                            counts.loc[index, "uORF_counts3"] += 1
                            counts.loc[index, "uORF_countssum"] += 1
                            lengths.append(uORF_length)
                            break
                    if ouORF_bool:
                        counts.loc[index, "ouORF_countssum"] += 1
                        counts.loc[index, "ouORF_counts3"] += 1

        '''Here we add the last columns to our DataFrame and clean it up for the final output'''

        counts.iloc[:, 2:] = counts.iloc[:, 2:].replace(0, np.nan)
        counts["uORF_meanlength"] = counts.loc[:, ["uORF_meanlength1", "uORF_meanlength2", "uORF_meanlength3"]].mean(
            axis=1)
        counts = counts.replace(np.nan, 0)
        cols_in_front = ["uORF_countssum", "uORF_meanlength", "ouORF_countssum"]
        counts = counts.loc[:,[c for c in cols_in_front if c in counts.columns] + [c for c in counts if c not in cols_in_front]]
        counts.index = counts.index + 1
        counts.rename(index={0: "SeqID"})

        return counts